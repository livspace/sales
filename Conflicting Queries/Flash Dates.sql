--http://reports.livspace.com/question/2012

select 

(case 
when lower(project_city) like '%bangalore%' or lower(project_city) like '%hyderabad%' or lower(project_city) like '%chennai%' or lower(project_city) like '%pune%' then project_city
when lower(project_city) like '%mumbai%' or lower(project_city) like '%thane%' then 'Mumbai'
when lower(project_city) like '%gurgaon%' or lower(project_city) like '%dwarka%' then 'Gurgaon'
when lower(project_city) like '%delhi%' or lower(project_city) like '%farida%' then 'Delhi'
when lower(project_city) like '%noida%' or lower(project_city) like '%ghaz%' then 'Noida'
end) as City,
prs.project_id as "Canvas ID",
date(prs.project_created_at) as "Project Created Date",
date(dq.event_date) as "Disqualification Date",
ps.display_name as "Stage Before Flash Sales",
ps1.display_name as "Stage After Flash Sales",
prs.project_stage,
prs.project_status

from flat_tables.flat_projects prs

left join flat_tables.flat_project_events fpe on fpe.project_id=prs.project_id

left join (SELECT *
FROM 
(SELECT project_id, 
        new_value,new_value_name,
        rank() OVER (PARTITION BY project_id ORDER BY event_date desc) AS project_id_ranked
 FROM flat_tables.flat_project_events where event_date<='2019-03-10' ORDER BY event_date desc
) AS ranked
WHERE ranked.project_id_ranked = 1) cs on cs.project_id=prs.project_id

left join launchpad_backend.project_stages ps on ps.id=cs.new_value


left join (SELECT *
FROM 
(SELECT project_id, 
        new_value,new_value_name,
        rank() OVER (PARTITION BY project_id ORDER BY event_date desc) AS project_id_ranked
 FROM flat_tables.flat_project_events where event_date<='2019-03-19' ORDER BY event_date desc
) AS ranked
WHERE ranked.project_id_ranked = 1) cs1 on cs1.project_id=prs.project_id

left join launchpad_backend.project_stages ps1 on ps1.id=cs1.new_value

left join (SELECT project_id as project_id,max(created_at) as event_date from launchpad_backend.project_events where lower(new_value) like '%inactive%' group by 1) 
dq on dq.project_id=prs.project_id

where prs.project_id in (343085,362724,357833,365637,350668,365213,293037,288142,352071,358207,357354,349128,288391,366075,365649,366166,302952,200682,284039,348066,353725,365080,351837,366108,269276,237398,332235,352884,267244,357630,351683,351188,260155,337528,346922,347937,357455,361268,345008,319603,350498,275289,363071,337530,348047,365515,365512,349245,362369,334132,363607,342101,335123,352181,312979,361123,362434,101654,362938,365484,359176,366409,341617,366073,315193,250269,313030,365494,331190,347681,361569,351597,344555,332113,358629,351736,349370,357907,328379,358153,280223,362032,321376,356210,352830,352138,321386,345287,282033,366207,360875,315270,350814,52276,365137,365141,364384,346907,365387,304535,349012,337937,347529,357926,365149,350828,362489,352928,359729,353320,358057,366335,360844,352576,354917,352214,354602,329837,318831,353763,316785,362881,366701,352241,345124,198526,298231,354998,358341,288605,361093,339122,345351,360418,357010,348071,366097,316206,362059,344833,169897,358268,362593,365849,350848,361044,365697,332193,364485,321488,11357,366632,366623,366598,365573,359620,346304,355434,363330,361332,318857,366187,366631,333891,319116,334422,363504,364724,352777,364409,359178,354122,283282,362710,340479,362330,366705,357258,334799,361537,200403,361975,365218,309631,366160,307107,322150,341142,354346,357547,343146,316996,215735,350464,355985,343289,353253,362547,356169,363216,361773,336994,366065,222364,296242,357989,322565,359109,365993,349738,366697,293955,366307,339572,351884,337600,342197,282387,366069,362737,354462,354947,364618,364984,361255,345694,366855,337960,350356,362092,365216,360115,366935,365030,358445,323762,334809,324591,346864,357680,436864,366356,343217,210911,363892,334534,366869,299938,365035,361250,249457,359025,335998,367008,363912,366694,360847,322983,366149,357462,283523,334452,329111,287810,360845,366757,301491,366606,309981,350866,227588,364520,342862,359570,354573,354423,364414,365750,353792,360278,347931,358265,361545,343288,350723,341291,365485,360573,296058,364577,333048,358217,14631,366412,351339,357481,367192,359755,304899,356452,350725,352469,359627,323915,366334,360076,332549,353827,360225,361055,355998,362623,333093,317812,36678,358635,315331,348943,365497,350847,363307,366220,303988,311398,323203,294576,364507,301381,366875,366635,347907,333327,352356,343029,237523,347257,364243,361396,362984,117581,328054,363410,346958,337285,350774,349500,328890,357194,346999,230965,363990,364500,361129,356121,366659,342860,360404,115900,367378,312196,362152,364863,316716,298547,365188,305199,356611,301852,345178,354169,90132,366921,218095,366257,366928,328136,366853,329943,365381,341311,288076,220174,337845,365138,367369,366523,367333,343621,309326,366132,366218,366848,366877,364750,271579,359672,364846,341197,316149,360799,357527,361274,365720,318725,361126,345022,364934,274774,259917,367469,267929,335293,358081,367421,367409,367207,366447,299871,365580,271653,366221,366857,336878,352149,627593,292217,355754,244572,181510,359612,362696,367380,367284,247645,361426,357592,362731,357511,366316,365629,359461,351103,357839,345434,367468,356413,340601,349056,359964,367397,269415,282455,367401,337791,307554,359521,367524,360213,350396,296795,288968,360779,366236,355857,290629,367492,349725,367394,366148,367404,366202,274363,362823,367392,355807,350340,316430,363910,360812,320838,367478,324533,348750,349019,365317,40478,238026,226687,355542,367351,327928,285333,351267,320214,358362,367437,313206,367487,329446,335882,362532,367484,366774,355951,347941,356736,336934,351901,347560,352776,313903,331776,367352,351365,283393,359574,361634,352823,367528,357340,348955,357350,358398,346463,349564,365747,300621,349870,303583,326575,333857,357227,35675,364015,366751,342743,367480,367506,359197,367265,357026,359861,360259,351600,365943,366678,360598,355979,270787,318374,367516,280216,251924,239634,316190,366728,358434,359869,337342,350821,332552,281980,367114,361486,362324,328832,339808,366980,367000,361607,366555,234417,367508,298877,4884,337444,367549,364578,290631,309140,366932,347753,223341,349022,348570,329630,360963,35236,336656,350395,366977,360883,353327,352423,366549,329029,366892,367598,298268,367234,367221,367357,363558,30372,360785,358209,343052,195084,220813,364418,341145,343447,361628,315498,339689,356376,347477,359448,355747,331638,341014,361067,343175,323595,357014,334062,353913,354825,362052,362891,309219,363562,331467,367466,367459,20407,361375,360631,365730,307514,367316,365856,347578,361786,367530,351769,351927,359852,361121,367424,340285,364289,366179,301843,356846,362880,341189,367475,365716,367132,350320,367491,357282,323669,732,331480,353921,364877,338968,364424,361619,364439,363735,367471,203744,322055,362678,299512,367597,338223,352160,93401,321221,343370,293885,367239,356240,293864,261652,367581,367591,365390,325374,317726,367534,333754,356418,365665,351859,317645,354250,358032,357915,358165,355455,347317,366597,358099,305105,344113,323349,361170,366208,356176,363958,357460,319781,332074,344211,332075,4805,364002,366783,356767,349087,361232,365339,356556,364370,315438,183552,317503,346975,343443,363552,350264,354531,367564,360765,188888,367273,367592,293741,361469,367588,367577,321408,366573,357389,364874,360649,367470,366801,367620,365527,360936,367440,354991,363804,363497,363049,367551,360760,366446,350921,334285,361021,367531,365242,364799,303496,365252,339460,334532,360899,325055,363946,311256,367051,362808,220244,352307,320502,362807,246796,348884,290060,270405,367619,362529,266859,302874,359780,340165,364517,354842,349699,367634,355872,267112,362898,362899,367050,363170,332154,319263,353436,342899,350485)

group by 1,2,3,4,5,6,7,8
