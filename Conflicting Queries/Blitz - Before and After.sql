--http://reports.livspace.com/question/2090

select 

(case 
when lower(project_city) like '%bangalore%' or lower(project_city) like '%hyderabad%' or lower(project_city) like '%chennai%' or lower(project_city) like '%pune%' then project_city
when lower(project_city) like '%mumbai%' or lower(project_city) like '%thane%' then 'Mumbai'
when lower(project_city) like '%gurgaon%' or lower(project_city) like '%dwarka%' then 'Gurgaon'
when lower(project_city) like '%delhi%' or lower(project_city) like '%farida%' then 'Delhi'
when lower(project_city) like '%noida%' or lower(project_city) like '%ghaz%' then 'Noida'
end) as City,
prs.project_id as "Canvas ID",
date(prs.project_created_at) as "Project Created Date",
date(dq.event_date) as "Disqualification Date",
date(ac.event_date) as "Reactivation Date",
ps.display_name as "Stage Before Flash Sales",
ps1.display_name as "Stage After Flash Sales",
prs.project_stage,
prs.project_status,
prs.primary_cm,
prs.primary_gm

from flat_tables.flat_projects prs

left join flat_tables.flat_project_events fpe on fpe.project_id=prs.project_id

left join (SELECT *
FROM 
(SELECT project_id, 
        new_value,new_value_name,
        rank() OVER (PARTITION BY project_id ORDER BY event_date desc) AS project_id_ranked
 FROM flat_tables.flat_project_events where event_date<='2019-08-02' ORDER BY event_date desc
) AS ranked
WHERE ranked.project_id_ranked = 1) cs on cs.project_id=prs.project_id

left join launchpad_backend.project_stages ps on ps.id=cs.new_value


left join (SELECT *
FROM 
(SELECT project_id, 
        new_value,new_value_name,
        rank() OVER (PARTITION BY project_id ORDER BY event_date desc) AS project_id_ranked
 FROM flat_tables.flat_project_events where event_date<='2019-08-06' ORDER BY event_date desc
) AS ranked
WHERE ranked.project_id_ranked = 1) cs1 on cs1.project_id=prs.project_id

left join launchpad_backend.project_stages ps1 on ps1.id=cs1.new_value

left join (SELECT project_id as project_id,max(created_at) as event_date from launchpad_backend.project_events where lower(new_value) like '%inactive%' group by 1) 
dq on dq.project_id=prs.project_id

left join (SELECT project_id as project_id,max(created_at) as event_date from launchpad_backend.project_events where lower(new_value) like 'active%' group by 1) 
ac on ac.project_id=prs.project_id

where prs.project_id in

(439015,423178,435923,439676,414813,406739,429117,264040,424975,420908,394209,381229,419836,431289,406476,385891,440157,427894,408613,425094,431917,428449,436020,422021,438131,424377,416492,400899,429852,412249,438679,440859,403113,321314,435179,415613,435960,438479,424858,372210,407203,440864,385537,433295,411890,427578,428479,440793,392358,409587,421162,436192,403134,432898,235494,413747,345655,440875,430605,431868,394797,402707,433689,440800,415352,279395,432973,434594,438603,440770,43041,435087,430770,413744,322352,400865,380430,427033,265940,441374,429072,395996,363456,428943,432812,437353,435246,382065,440370,427156,432736,419909,413704,440870,409117,419244,408088,367223,410847,439459,407612,283829,281158,331582,428303,371791,391334,351382,433957,421158,382875,338035,289463,293273,421753,434975,344363,424079,402803,441510,438909,334532,410797,404483,433262,423278,268003,435617,241260,438300,437719,441623,427838,440275,46031,441671,386721,433520,440505,436107,359616,432399,429001,439166,417751,372128,82760,419146,411374,42464,441418,419536,423011,373118,400416,425684,382089,438468,431302,364575,434692,246712,429581,439232,435591,432677,420385,426750,286875,434295,430510,436262,436663,438752,440925,312064,353895,439138,441470,441386,436708,433972,405567,357426,378493,388111,349251,436629,406435,435319,433952,105038,405920,430968,377751,435675,433725,442028,438507,420393,438392,376905,439149,439609,434902,442041,430278,422278,442039,441999,392816,411199,429180,434502,432175,416428,212394,429194,441637,440510,434597,439326,417068,369905,411063,429997,209674,423349,409897,442148,419864,432668,415935,369812,428027,419675,441672,439122,374529,409592,440162,282624,358403,396138,403644,431467,437148,407687,432805,441604,27301,440846,440411,436791,392366,441008,432498,413446,430123,440761,440556,438681,437514,396542,433545,441538,378805,441439,366916,425891,435829,427964,391082,407457,366340,265578,425095,422452,289127,402835,406757,353940,394386,427875,431998,436264,433883,305232,438999,436558,120374,432837,347317,431606,436410,425035,433586,437044,419365,427067,440235,393135,427015,410492,418608,440877,430467,434652,366005,368020,437222,427767,424152,437232,441635,332236,428403,439182,442008,419070,374963,418704,429091,440751,441641,414856,441233,386063,412239,114020,403400,439681,430877,360861,421697,411109,432474,426566,437075,433922,418649,384552,434249,438769,423214,414405,441718,383588,290317,380276,440160,432391,391127,429901,438814,407543,430386,419859,417670,424737,435901,411152,333363,430260,417683,423966,426261,423146,436743,432633,442118,440891,360711,435580,434437,432295,426137,336512,440409,426778,425857,422543,387576,439201,440445,440795,411262,419811,438702,442308,442263,439180,441964,306108,423379,440798,442291,432324,434265,440730,430613,421816,312205,422478,410267,430424,429657,432899,431250,427318,442184,399375,435242,442169,396463,437535,422287,382915,390413,405776,404545,398007,387535,351772)

group by 1,2,3,4,5,6,7,8,9,10,11
